Anonifyはプライバシを保護した上で、ブロックチェーンを改ざん不可能なデータ共有基盤として用いることを可能にするシステムです。
通常のブロックチェーンのように、状態遷移の履歴を平文のまま記録していくのではなく、AnonifyではTEEで暗号化された状態データをブロックチェーンに記録していきます。TEEサーバの隔離保護領域内で状態遷移の計算を行い、その結果を暗号化しブロックチェーンに記録します。Enclave内のデータはハードウェアレベルで外部から保護され、TEEを運営している管理者自身やOSなどのシステムソフトウェアもアクセスできないように保護されています。

ネットワークに参加しているTEE同士はブロックチェーンを介し、暗号化・復号に用いられるグループ鍵を共有しています。これにより、あるTEEがブロックチェーンにブロードキャストした暗号文を取得し、Enclave内で復号することでTEEの最新状態を更新することが可能です。つまり、ブロックチェーンには全ての状態遷移の履歴を暗号文として記録し、TEEは最新の状態を平文として記録しています。

Enclaveで処理される状態遷移ルールは、TEEのRemote Attestationの仕組みで強制されます。ネットワークに参加するTEEは、Remote Attestationの署名付きの結果データ (REPORT) をブロックチェーンに送信し、スマートコントラクトでREPORTの署名検証をすることで改ざんされていないことを検証します。それぞれのTEEは、REPORTに含まれるEnclaveで実行された状態遷移ルールのハッシュ値 (MRENCLAVE) がセットアップ時に登録されたものと一致しているか検証します。MMRENCLAVEが一致する限り、全てのTEEは同じ状態遷移ルールを実行していることが保証されます。

つまり、状態遷移の処理自体はそれぞれのTEEが個別に行い、状態遷移ルールの検証は全ての参加者がブロックチェーン上のスマートコントラクトで行うことになります。これにより、全ての参加者間でTEEで実行される状態遷移ルールは正しいことを検証し、その状態遷移の結果、履歴は暗号化された状態で全てブロックチェーンに記録するということが可能になります。

<div align="center">
<img src="https://user-images.githubusercontent.com/20852667/81645749-16011980-9465-11ea-80c2-9fe3b11e0ff1.png" width="1400px">
</div>

以上が、TEEにおける状態遷移および、ブロックチェーンへ暗号文をブロードキャストするワークフローの図です。Authenticationレイヤにより特定の認証情報を保持しているクライアントではないとState Cacheにはアクセスできません。State Cacheには最新の状態が記録されています。その状態データとインプットデータを元に状態遷移の処理を行い、TreeKEMレイヤでグループ鍵による暗号化を行い、ブロックチェーンにブロードキャストします。State Hashレイヤでは状態の一致検証を行うためのハッシュ計算を行います。ブロックチェーンに記録された暗号文はTEEに読み取られ、再びTreeKEMで復号後、更新状態データとしてState Cacheに記録されます。Sealingは、on-chipの鍵でState Cacheを暗号化し外部ストレージに記録するための機能を持ちます。Attestationは、TEEをブロックチェーンに登録するときにプログラムの完全性を検証するための機能です。